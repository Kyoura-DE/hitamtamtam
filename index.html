<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OrderKuota Tools</title>
  <style>
    body { font-family: sans-serif; max-width: 400px; margin: 30px auto; }
    input, button { width: 100%; padding: 10px; margin: 5px 0; }
    pre { background: #f9f9f9; padding: 10px; white-space: pre-wrap; word-break: break-all; }
    h3 { text-align: center; }
    .page { display: none; }
    .active { display: block; }
  </style>
</head>
<body>
  <!-- Page 1: Token Extractor -->
  <div id="pageTokenExtractor" class="page active">
    <h3>OrderKuota Token Extractor</h3>
    <input id="username" placeholder="Username">
    <input id="password" placeholder="Password" type="password">
    <input id="otp" placeholder="Masukkan OTP">
    <button id="loginBtn">Login</button>
    <button id="gotoMutasiBtn">‚û°Ô∏è Buka Check Mutasi QRIS</button>
    <pre id="resultToken">Masukkan username dan password untuk mendapatkan token & merchant_id.</pre>
  </div>

  <!-- Page 2: Check Mutasi QRIS -->
  <div id="pageMutasiQris" class="page">
    <h3>Check Mutasi QRIS</h3>
    <input id="merchant_id" placeholder="Merchant ID">
    <input id="token" placeholder="Token">
    <input id="usernameMutasi" placeholder="Username">
    <button id="checkMutasiBtn">Check Mutasi QRIS</button>
    <button id="gotoTokenBtn">‚¨ÖÔ∏è Kembali ke Token Extractor</button>
    <pre id="resultMutasi">Masukkan Merchant ID, Token, dan Username untuk cek mutasi QRIS.</pre>
  </div>

  <script>
    // Element references
    const pageToken = document.getElementById('pageTokenExtractor');
    const pageMutasi = document.getElementById('pageMutasiQris');
    const otpInput = document.getElementById('otp');
    const loginBtn = document.getElementById('loginBtn');
    const gotoMutasiBtn = document.getElementById('gotoMutasiBtn');
    const gotoTokenBtn = document.getElementById('gotoTokenBtn');
    const resultToken = document.getElementById('resultToken');
    const resultMutasi = document.getElementById('resultMutasi');
    const checkMutasiBtn = document.getElementById('checkMutasiBtn');

    let savedToken = "";
    let savedMerchantId = "";

    // Switcher
    function showPage(page) {
      pageToken.classList.remove('active');
      pageMutasi.classList.remove('active');
      page.classList.add('active');
    }

    // Go to Mutasi QRIS Page
    gotoMutasiBtn.addEventListener('click', () => {
      document.getElementById('merchant_id').value = savedMerchantId;
      document.getElementById('token').value = savedToken;
      document.getElementById('usernameMutasi').value = document.getElementById('username').value;
      showPage(pageMutasi);
    });

    // Back to Token Extractor Page
    gotoTokenBtn.addEventListener('click', () => {
      showPage(pageToken);
    });

    // Login Token Extractor Logic
    loginBtn.addEventListener('click', async () => {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const otp = otpInput.value.trim();

      if (!username || !password) {
        resultToken.textContent = "‚ùå Username dan Password tidak boleh kosong.";
        return;
      }

      resultToken.textContent = "‚è≥ Memproses login...";

      try {
        const res = await fetch('/api', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, otp })
        });
        const data = await res.json();
        console.log("Response /api:", data);

        if (data.need_otp) {
          otpInput.style.display = 'block';
          resultToken.textContent = `üîë OTP telah dikirim ke: ${data.message}\nMasukkan OTP lalu klik Login kembali.`;
        } else if (data.success) {
          savedToken = data.token;
          savedMerchantId = data.merchant_id;
          otpInput.style.display = 'none';
          otpInput.value = '';
          resultToken.textContent =
`‚úÖ Login Berhasil!

TOKEN:
${data.token}

MERCHANT_ID:
${data.merchant_id}

NAMA: ${data.name}
USERNAME: ${data.username}
SALDO: ${data.balance}

Klik "‚û°Ô∏è Buka Check Mutasi QRIS" untuk melihat mutasi QRIS.`;
        } else {
          resultToken.textContent = `‚ùå ${data.message || 'Terjadi kesalahan.'}`;
        }
      } catch (e) {
        console.error(e);
        resultToken.textContent = `‚ùå Gagal memproses: ${e.message}`;
      }
    });

    // Check Mutasi QRIS Logic
    checkMutasiBtn.addEventListener('click', async () => {
      const merchant_id = document.getElementById('merchant_id').value.trim();
      const token = document.getElementById('token').value.trim();
      const username = document.getElementById('usernameMutasi').value.trim();

      if (!merchant_id || !token || !username) {
        resultMutasi.textContent = "‚ùå Merchant ID, Token, dan Username tidak boleh kosong.";
        return;
      }

      resultMutasi.textContent = "‚è≥ Mengambil Mutasi QRIS...";

      try {
        const res = await fetch('/api/qris', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ merchant_id, token, username })
        });
        const data = await res.json();
        console.log("Response /api/qris:", data);

        if (data.success) {
          resultMutasi.textContent = `‚úÖ Mutasi QRIS:\n\n${data.mutasi.join('\n')}\n\nSaldo Utama: ${data.saldo_utama}\nSaldo QRIS: ${data.saldo_qris}`;
        } else {
          resultMutasi.textContent = `‚ùå Gagal mengambil mutasi QRIS: ${data.message}`;
        }
      } catch (e) {
        console.error(e);
        resultMutasi.textContent = `‚ùå Gagal memproses: ${e.message}`;
      }
    });
  </script>
</body>
</html>
